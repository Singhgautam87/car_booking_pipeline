pipeline {
    agent any

    environment {
        COMPOSE_FILE = "docker-compose.yml"
    }
    
    stages {
        stage("Checkout Code") {
            steps {
                checkout scm
                sh "echo 'Code checked out successfully' && ls -la"
            }
        }
        
        stage('Start Containers') {
            steps {
                script {
                    sh '''
                        echo "üîç Checking container status..."
                        
                        # Function to check if container exists (running or stopped)
                        container_exists() {
                            docker ps -a --format '{{.Names}}' | grep -q "^$1$"
                        }
                        
                        # Function to check if container is running
                        container_running() {
                            docker ps --format '{{.Names}}' | grep -q "^$1$"
                        }
                        
                        # Great Expectations container handling
                        if container_exists "great_expectations"; then
                            if container_running "great_expectations"; then
                                echo "‚úÖ Great Expectations container already running - reusing it"
                            else
                                echo "üîÑ Great Expectations container exists but stopped - starting it"
                                docker start great_expectations
                                sleep 5
                            fi
                        else
                            echo "üöÄ Creating and starting Great Expectations container..."
                            docker-compose up -d great_expectations
                            sleep 10
                        fi
                        
                        # Start other containers
                        echo "üöÄ Starting other infrastructure containers..."
                        docker-compose up -d
                        
                        # Wait for services to be ready
                        echo "‚è≥ Waiting for all services to stabilize..."
                        sleep 15
                        
                        # Show status
                        echo "üìã Container Status:"
                        docker-compose ps
                        
                        # Verify Great Expectations is healthy
                        echo "üîç Verifying Great Expectations setup..."
                        docker exec great_expectations python -c "import great_expectations; print('‚úÖ GE version:', great_expectations.__version__)" || {
                            echo "‚ùå Great Expectations not working properly"
                            exit 1
                        }
                    '''
                }
            }
        }

        stage("Kafka Producer") {
            steps {
                sh '''
                    echo "üì§ Starting Kafka producer..."
                    
                    # Wait for Kafka to be ready
                    echo "‚è≥ Waiting for Kafka to be ready..."
                    sleep 5
                    
                    # Create topic if not exists
                    docker exec kafka kafka-topics --create --if-not-exists \
                        --topic car-bookings \
                        --bootstrap-server localhost:9092 \
                        --partitions 3 \
                        --replication-factor 1 || echo "Topic already exists or error creating"
                    
                    # Run producer
                    docker exec kafka python /kafka/producer.py
                '''
            }
        }

        stage("Spark Streaming Ingest") {
            steps {
                sh '''
                    echo "‚ö° Running Spark streaming job..."
                    docker exec spark-master spark-submit /opt/spark-apps/ingest_stream.py
                '''
            }
        }

        stage("Transform & Merge") {
            steps {
                sh '''
                    echo "üîÑ Transforming and merging data..."
                    docker exec spark-master spark-submit /opt/spark-apps/transform_booking.py
                    docker exec spark-master spark-submit /opt/spark-apps/transform_customer.py
                    docker exec spark-master spark-submit /opt/spark-apps/merge_customer_booking.py
                    docker exec spark-master spark-submit /opt/spark-apps/write_to_postgres.py
                '''
            }
        }

        stage('Data Quality - Great Expectations') {
            steps {
                script {
                    sh '''
                        echo "üìä Running Great Expectations validations..."
                        
                        # Check if container is running
                        if ! docker ps --format '{{.Names}}' | grep -q "^great_expectations$"; then
                            echo "‚ùå Great Expectations container not running!"
                            echo "üîÑ Attempting to start..."
                            docker start great_expectations || docker-compose up -d great_expectations
                            sleep 5
                        fi
                        
                        # Run checkpoint in existing container
                        docker exec great_expectations python /ge/run_checkpoint.py
                        
                        # Check validation results
                        if [ $? -eq 0 ]; then
                            echo "‚úÖ Data quality checks PASSED"
                        else
                            echo "‚ùå Data quality checks FAILED"
                            exit 1
                        fi
                    '''
                }
            }
        }

        stage("Load MySQL (Final)") {
            steps {
                sh '''
                    echo "üíæ Loading data to MySQL..."
                    docker exec spark-master spark-submit /opt/spark-apps/write_to_mysql.py
                '''
            }
        }
    }

    post {
        success {
            echo '‚úÖ PIPELINE COMPLETED SUCCESSFULLY'
            sh '''
                echo "üìã Final Container Status:"
                docker-compose ps
            '''
        }
        failure {
            echo '‚ùå PIPELINE FAILED ‚Äì CHECK LOGS'
            sh '''
                echo "üìã Container Status at Failure:"
                docker-compose ps
                
                echo "üìù Great Expectations Container Logs:"
                docker logs great_expectations --tail 50 || echo "Could not fetch GE logs"
            '''
        }
        always {
            sh '''
                echo "üèÅ Pipeline execution completed"
            '''
        }
    }
}