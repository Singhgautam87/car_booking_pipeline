pipeline {
    agent any

    environment {
        COMPOSE_FILE = "docker-compose.yml"
    }
    
    stages {
        stage("Checkout Code") {
            steps {
                checkout scm
                sh "echo 'Code checked out successfully' && ls -la"
            }
        }
        
        stage("Start Containers") {
            steps {
                sh "docker-compose up -d"
            }
        }

        stage("Kafka Producer") {
            steps {
                sh "docker exec car-booking-pipeline-kafka-1 python /kafka/producer.py"
            }
        }

        stage("Spark Streaming Ingest") {
            steps {
                sh "docker exec spark spark-submit /opt/spark-apps/ingest_stream.py"
            }
        }

        stage("Transform & Merge") {
            steps {
                sh """
                docker exec spark spark-submit /opt/spark-apps/transform_booking.py
                docker exec spark spark-submit /opt/spark-apps/transform_customer.py
                docker exec spark spark-submit /opt/spark-apps/merge_customer_booking.py
                docker exec spark spark-submit /opt/spark-apps/write_to_postgres.py
                """
            }
        }

        stage("Data Quality - Great Expectations") {
            steps {
                sh "docker-compose run --rm great_expectations"
            }
        }

        stage("Load MySQL (Final)") {
            steps {
                sh "docker exec spark spark-submit /opt/spark-apps/write_to_mysql.py"
            }
        }
    }

    post {
        success {
            echo "✅ PIPELINE COMPLETED SUCCESSFULLY"
        }
        failure {
            echo "❌ PIPELINE FAILED – CHECK LOGS"
        }
    }
}